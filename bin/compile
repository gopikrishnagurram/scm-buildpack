#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

echo "=====> starting SCM buildpack compile"
DIR=$(mktemp -t buildpackXXXXX)
rm -rf $DIR
mkdir -p "$DIR"

SCM_URL=${SCM_URL}
echo "=====> SCM_URL is $SCM_URL"
SCM_BRANCH=${GIT_BRANCH}
if [ "$SCM_BRANCH" != "" ]; then
  echo "=====> SCM_BRANCH is $SCM_BRANCH"
fi

if [ "$SCM_URL" != "" ]; then
  if [[ "$SCM_URL" =~ \.(tgz)$ ]]; then
    echo "=====> Downloading tgz archive: $SCM_URL"
    curl -k -s "$SCM_URL" | tar xvz -C "$DIR"
  elif [[ "$SCM_URL" =~ \.(zip)$ ]]; then
    echo "=====> Downloading zip archive: $SCM_URL"
	tempfile=$(mktemp -t tempXXXXX)
	curl -k -o "$tempfile" "$SCM_URL"
	unzip "$tempfile" -d "$DIR"
	rm "$tempfile"
  else
    echo "=====> Downloading git repo: $SCM_URL"
    git clone $SCM_URL $DIR
  fi
  echo "=====> Download finished"

  if [ "$SCM_BRANCH" != "" ]; then
    git checkout $SCM_BRANCH
  fi

  echo "=====> copying contents of $DIR to $1"
  cd $DIR
  cp -R $DIR/* $1
  echo "=====> final contents of build dir"
  ls -al $1
fi
