#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

while : ; do
  echo "=====> starting git buildpack compile"
  dir=$(mktemp -t buildpackXXXXX)
  echo "=====> dir is ${dir}"
  rm -rf $dir

  url=${GIT_URL}
  echo "=====> url is ${url}"
  branch=${GIT_BRANCH}
  echo "=====> branch is is ${branch}"

  if [ "$branch" == "$url" ]; then
    branch=""
  fi

  if [ "$url" != "" ]; then
    echo "=====> Downloading git repo: $url"

    if [[ "$url" =~ \.tgz$ ]]; then
      mkdir -p "$dir"
      curl -s "$url" | tar xvz -C "$dir" >/dev/null 2>&1
    else
      git clone $url $dir >/dev/null 2>&1
    fi
    cd $dir

    if [ "$branch" != "" ]; then
      git checkout $branch >/dev/null 2>&1
    fi

    cp -R $dir $1
    echo "=====> final contents of build dir"
    ls -al $1
  fi
  break
done