#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e -x

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

while : ; do
  echo "=====> starting git buildpack compile"
  dir=$(mktemp -t buildpackXXXXX)
  echo "=====> dir is ${dir}"
  rm -rf $dir
  mkdir -p "$dir"

  url=${GIT_URL}
  echo "=====> url is ${url}"
  branch=${GIT_BRANCH}
  echo "=====> branch is is ${branch}"

  if [ "$branch" == "$url" ]; then
    branch=""
  fi

  if [ "$url" != "" ]; then

    if [[ "$url" =~ \.(tgz)$ ]]; then
      echo "=====> Downloading tgz archive: $url"
      curl -s "$url" | tar xvz -C "$dir" >/dev/null 2>&1
    elif [[ "$url" =~ \.(zip)$ ]]; then
		tempfile=$(mktemp -t tempXXXXX)
		wget "$url" -O "$tempfile"
		unzip "$tempfile" -d "$dir"
    else
      echo "=====> Downloading git repo: $url"
      git clone $url $dir >/dev/null 2>&1
    fi

    if [ "$branch" != "" ]; then
      git checkout $branch >/dev/null 2>&1
    fi

    echo "=====> copying contents of $dir to $1"
    cd $dir
    cp -R $dir/* $1
    echo "=====> final contents of build dir"
    ls -al $1
  fi
  break
done