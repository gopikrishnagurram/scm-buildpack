#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

echo "=====> starting SCM buildpack compile"
dir=$(mktemp -t buildpackXXXXX)
rm -rf $dir
mkdir -p "$dir"

SCM_URL=${SCM_URL}
echo "=====> SCM_URL is $SCM_URL"
branch=${GIT_BRANCH}
if [ "$branch" != "" ]; then
  echo "=====> branch is is ${branch}"
fi

if [ "$SCM_URL" != "" ]; then
  if [[ "$SCM_URL" =~ \.(tgz)$ ]]; then
    echo "=====> Downloading tgz archive: $SCM_URL"
    curl -k -s "$SCM_URL" | tar xvz -C "$SCM_URL"
  elif [[ "$SCM_URL" =~ \.(zip)$ ]]; then
    echo "=====> Downloading zip archive: $SCM_URL"
	tempfile=$(mktemp -t tempXXXXX)
	curl -k -o "$tempfile" "$SCM_URL"
	unzip "$tempfile" -d "$dir"
	rm "$tempfile"
  else
    echo "=====> Downloading git repo: $SCM_URL"
    git clone $SCM_URL $dir
  fi
  echo "=====> Download finished"

  if [ "$branch" != "" ]; then
    git checkout $branch
  fi

  echo "=====> copying contents of $dir to $1"
  cd $dir
  cp -R $dir/* $1
  echo "=====> final contents of build dir"
  ls -al $1
fi
